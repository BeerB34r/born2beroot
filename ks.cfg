# Generated by Anaconda 34.25.4.9
# Generated by pykickstart v3.32
#version=RHEL9
# Use graphical install
cmdline
repo --name="minimal" --baseurl=file:///run/install/sources/mount-0000-cdrom/minimal

%addon com_redhat_kdump --disable

%end

# Keyboard layouts
keyboard --xlayouts='us'
# System language
lang en_US.UTF-8

# Network information
network  --bootproto=dhcp --device=enp0s3 --ipv6=auto --activate
network  --hostname=mde-beer42

# Use CDROM installation media
cdrom

%packages
@^minimal-environment
%end
# Run the Setup Agent on first boot
firstboot --enable
reboot

# Generated using Blivet version 3.6.0
# System bootloader configuration
bootloader --location=mbr --boot-drive=sda
# Partition clearing information
clearpart --all --initlabel
# Disk partitioning information
part /boot --fstype="ext4" --label=sda1 --size=512
part pv.136 --fstype="lvmpv" --label=sda5 --encrypted --luks-version=luks1 --passphrase=Born2beauto --grow
volgroup LVMGroup pv.136
logvol swap --fstype="swap" --name=swap --vgname=LVMGroup --size=2048
logvol /srv --fstype="ext4" --name=srv --vgname=LVMGroup --size=3072
logvol /var/log --fstype="ext4" --name=var-log --vgname=LVMGroup --size=4096
logvol /var --fstype="ext4" --name=var --vgname=LVMGroup --size=3072
logvol /tmp --fstype="ext4" --name=tmp --vgname=LVMGroup --size=3072
logvol /home --fstype="ext4" --name=home --vgname=LVMGroup --size=5120
logvol / --fstype="ext4" --name=root --vgname=LVMGroup --size=10240

# System timezone
timezone Europe/Amsterdam --utc

# Root password
rootpw Born2beauto
user --groups=sudo,user42 --name=mde-beer --password=Born2beauto --uid=4242 --gecos="Mats de Beer" --gid=4242
firewall --port=4242:tcp,3306:tcp,9000:tcp
firewall --service=http
firewall --service=https

%post
# software install
sudo dnf install -y selinux-policy-targeted && echo "selinux-policy-targeted" >>/usr/bin/post-install
sudo dnf install -y policycoreutils-python-utils && echo "policycoreutils-python-utils" >>/usr/bin/post-install
sudo dnf install -y vim && echo "vim" >>/usr/bin/post-install
sudo dnf install -y epel-release && echo "epel-release" >>/usr/bin/post-install
sudo dnf install -y cronie && echo "cronie" >>/usr/bin/post-install
sudo dnf install -y unzip && echo "unzip" >>/usr/bin/post-install
sudo dnf install -y wget && echo "wget" >>/usr/bin/post-install
sudo dnf install -y php-mbstring && echo "php-mbstring" >>/usr/bin/post-install
sudo dnf install -y php-xml && echo "php-xml" >>/usr/bin/post-install
sudo dnf install -y php-gd && echo "php-gd" >>/usr/bin/post-install
sudo dnf install -y php-fpm && echo "php-fpm" >>/usr/bin/post-install
sudo dnf install -y php-mysqlnd && echo "php-mysqlnd" >>/usr/bin/post-install
sudo dnf install -y php && echo "php" >>/usr/bin/post-install
sudo dnf install -y mariadb-server && echo "mariadb-server" >>/usr/bin/post-install
sudo dnf install -y mariadb && echo "mariadb" >>/usr/bin/post-install
sudo dnf install -y lighttpd-fastcgi && echo "lighttpd-fastcgi" >>/usr/bin/post-install
sudo dnf install -y lighttpd && echo "lighttpd" >>/usr/bin/post-install
# ssh setup
sudo semanage port -a -t ssh_port_t -p tcp 4242
sudo echo "Port 4242" >> /etc/ssh/sshd_config
sudo echo "PermitRootLogin no" >> /etc/ssh/sshd_config
sudo echo "PasswordAuthentication yes" >> /etc/ssh/sshd_config
# password policy setup
sudo echo "minlen = 10" >> /etc/security/pwquality.conf
sudo echo "difok = 7" >> /etc/security/pwquality.conf
sudo echo "dcredit = -1" >> /etc/security/pwquality.conf
sudo echo "ucredit = -1" >> /etc/security/pwquality.conf
sudo echo "lcredit = -1" >> /etc/security/pwquality.conf
sudo echo "maxrepeat = 3" >> /etc/security/pwquality.conf
sudo echo "gecoscheck = 1" >> /etc/security/pwquality.conf
sudo sed -i'' -Ee 's/(PASS_MAX_DAYS\s+)[0-9]+/\130/' -e 's/(PASS_MIN_DAYS\s+)[0-9]+/\12/' -e 's/(PASS_WARN_AGE\s+)[0-9]+/\17/' /etc/login.defs
sudo sed -i'' -Ee 's/(password\s+requisite\s+pam_pwquality\.so\s).*/\1try_first_pass local_users_only retry=3 authtok_type= minlen=10 ucredit=-1 lcredit=-1 dcredit=-1 difok=3 reject_username enforce_for_root/' -e 's/(password\s+sufficient\s+pam_unix\.so).*/\1 remember=7/' /etc/pam.d/system-auth
sudo sed -i'' -Ee 's/(password\s+requisite\s+pam_pwquality\.so\s).*/\1try_first_pass local_users_only retry=3 authtok_type= minlen=10 ucredit=-1 lcredit=-1 dcredit=-1 difok=3 reject_username enforce_for_root/' -e 's/(password\s+sufficient\s+pam_unix\.so).*/\1 remember=7/' /etc/pam.d/password-auth
# sudo stuff
sudo echo "Defaults	passwd_tries=3" >> /etc/sudoers
sudo echo "Defaults	badpass_message=\"absolute dogshit\"" >> /etc/sudoers
sudo echo "Defaults	passprompt=\"what the su doing\n\"" >> /etc/sudoers
sudo echo "Defaults	log_input" >> /etc/sudoers
sudo echo "Defaults	log_output" >> /etc/sudoers
sudo echo "Defaults	iolog_dir=/var/log/sudo" >> /etc/sudoers
sudo echo "Defaults	logfile=/var/log/sudo/sudo.log" >> /etc/sudoers
sudo echo "Defaults	requiretty" >> /etc/sudoers
sudo echo "Defaults	insults" >> /etc/sudoers
sudo sed -i'' -Ee 's/(Defaults\s+secure_path\s+=\s+).*/\1"\/usr\/local\/sbin:\/usr\/local\/bin:\/usr\/sbin:\/usr\/bin:\/sbin:\/bin:\/snap\/bin"/' /etc/sudoers
sudo sed -i'' -Ee 's/wheel/sudo/g' /etc/sudoers
# cron and the rest of the services
sudo systemctl start crond
sudo systemctl enable crond
sudo systemctl start lighttpd
sudo systemctl enable lighttpd
sudo systemctl start mariadb
sudo systemctl enable mariadb
sudo systemctl start php-fpm
sudo systemctl enable php-fpm
sudo dnf update -y
sudo dnf upgrade -y
%end
